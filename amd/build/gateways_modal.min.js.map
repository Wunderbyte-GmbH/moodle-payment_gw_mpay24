{"version":3,"sources":["../src/gateways_modal.js"],"names":["showModalWithPlaceholder","ModalFactory","Templates","render","body","create","modal","show","process","component","paymentArea","itemId","Promise","all","Repository","getConfigForJs","then","mpay24Config","require","$","str","localStrings","get_strings","key","when","done","localizedEditStrings","optionsel","document","createElement","context","paymentarea","itemid","tid","renderForPromise","html","js","appendNodeContents","catch","language","header","textContent","container","insertAdjacentElement","iframe","setAttribute","tokenizerlocation","buttons","buttontext","innerHTML","token","script","type","appendChild","createTextNode","head","addEventListener","event","formData","FormData","target","entries","values","preventDefault","url","rooturl","clientid","window","location","href","setBody","promise","resolve"],"mappings":"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","sourcesContent":["/* eslint-disable max-len */\n/* eslint-disable no-unused-vars */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for mpay24 content in the gateways modal.\n *\n * @module     paygw_mpay24/gateway_modal\n * @copyright  2022 Wunderbyte Gmbh <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Repository from './repository';\nimport Templates from 'core/templates';\nimport Truncate from 'core/truncate';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {\n    get_string as getString\n} from 'core/str';\n\n/**\n * Creates and shows a modal that contains a placeholder.\n *\n * @returns {Promise<Modal>}\n */\nconst showModalWithPlaceholder = async () => {\n    const modal = await ModalFactory.create({\n        body: await Templates.render('paygw_mpay24/mpay24_button_placeholder', {})\n    });\n    modal.show();\n    return modal;\n};\n\n/**\n * Process the payment.\n *\n * @param {string} component Name of the component that the itemId belongs to\n * @param {string} paymentArea The area of the component that the itemId belongs to\n * @param {number} itemId An internal identifier that is used by the component\n * @param {string} description Description of the payment\n * @returns {Promise<string>}\n */\nexport const process = (component, paymentArea, itemId, description) => {\n    return Promise.all([\n            showModalWithPlaceholder(),\n            Repository.getConfigForJs(component, paymentArea, itemId),\n        ])\n        .then(([modal, mpay24Config]) => {\n            return Promise.all([\n                modal,\n                mpay24Config,\n            ]);\n        })\n        .then(([modal, mpay24Config]) => {\n\n            require(['jquery', 'core/str'], function($, str) {\n\n                var strings = [\n                    {\n                        key: 'quick_checkout',\n                        component: 'paygw_mpay24'\n                    },\n                    {\n                        key: 'paycredit',\n                        component: 'paygw_mpay24'\n                    }\n                ];\n\n                var localStrings = str.get_strings(strings);\n                $.when(localStrings).done(function(localizedEditStrings) {\n\n\n            const optionsel = document.createElement('div');\n\n            const context = {\n                component,\n                paymentarea: paymentArea,\n                itemid: itemId,\n                tid: mpay24Config.tid\n            };\n\n\n            Templates.renderForPromise('paygw_mpay24/paymentoptions', context).then(({html, js}) => {\n                    Templates.appendNodeContents(optionsel, html, js);\n                    return true;\n                }).catch();\n\n            const language = mpay24Config.language;\n            const header = document.createElement('h4');\n            header.textContent = localizedEditStrings[0];\n            const container = document.createElement('div');\n            container.insertAdjacentElement('afterbegin', header);\n\n            const iframe = document.createElement('iframe');\n            iframe.setAttribute('src', mpay24Config.tokenizerlocation);\n            iframe.setAttribute('style', \"width: 100%\");\n            const buttons = document.createElement('form');\n            let buttontext = localizedEditStrings[1];\n\n            buttons.innerHTML = `<form id=\"paymentform\"  method=\"POST\">\n            <input name=\"token\" type=\"hidden\" value=\"${mpay24Config.token}\" />\n            <button id=\"paybutton\" name=\"type\" value=\"TOKEN\" type=\"submit\" disabled=\"true\">${buttontext}</button>\n            </form>`;\n            container.insertAdjacentElement('beforeend', iframe);\n            container.insertAdjacentElement('beforeend', buttons);\n            container.insertAdjacentElement('beforeend', optionsel);\n\n            const script = document.createElement('script');\n            script.type = 'text/javascript';\n            const code = `\n            window.addEventListener(\"message\", checkValid, false);\n            function checkValid(form) {\n            var data = JSON.parse(form.data);\n            if (data.valid === \"true\") {\n                document.getElementById(\"paybutton\").disabled=false;\n            }\n            }\n            `;\n            script.appendChild(document.createTextNode(code));\n\n            document.head.appendChild(script);\n\n            buttons.addEventListener('submit', (event) => {\n\n                const formData = new FormData(event.target);\n                const entries = [...formData.entries()];\n                const values = [...formData.values()];\n                event.preventDefault();\n                const url = `${mpay24Config.rooturl}/payment/gateway/mpay24/checkout.php?token=${values[0]}&customer=${mpay24Config.clientid}&itemid=${itemId}&component=${component}&paymentarea=${paymentArea}&tid=${mpay24Config.tid}&ischeckstatus=${false}`;\n                window.location.href = url;\n\n            });\n\n            modal.setBody(container);\n\n                });\n\n            });\n\n            return '';\n\n        }).then(x => {\n            const promise = new Promise(resolve => {\n                window.addEventListener('onbeforeunload', (e) => {\n                    promise.resolve();\n                });\n            });\n            return promise;\n        });\n};"],"file":"gateways_modal.min.js"}